<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Medical Certificate</title>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100">
<div id="root"></div>

<script type="text/babel">
const { useState } = React;

/* ================= CRYPTO ================= */
function canonical(obj) {
  return JSON.stringify(obj, Object.keys(obj).sort());
}

async function sha256(text) {
  const data = new TextEncoder().encode(text);
  const hash = await crypto.subtle.digest("SHA-256", data);
  return [...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,"0")).join("");
}

/* ================= CONFIG ================= */
const WORKER_URL = "https://your-worker-name.workers.dev";

/* ================= APP ================= */
function App() {
  const [doctor, setDoctor] = useState("");
  const [cert, setCert] = useState(null);
  const [status, setStatus] = useState("");

  async function issue(patient) {
    const unsigned = {
      id: "MC" + Date.now().toString(36).toUpperCase(),
      patient,
      doctor,
      issuedAt: new Date().toISOString()
    };

    const hash = await sha256(canonical(unsigned));
    const certificate = { ...unsigned, hash };

    setCert(certificate);
    setStatus("Anchoring on blockchain...");

    const res = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ hash: "0x" + hash })
    });

    const json = await res.json();
    setStatus(json.success
      ? "✔ Anchored on blockchain"
      : "❌ Anchoring failed");
  }

  return (
    <div className="max-w-md mx-auto p-4 space-y-4">
      <h1 className="text-xl font-semibold">Medical Certificate</h1>

      <input
        className="border p-2 w-full"
        placeholder="Doctor name"
        onChange={e=>setDoctor(e.target.value)}
      />

      <button
        className="bg-blue-600 text-white px-4 py-2 rounded"
        onClick={()=>issue(prompt("Patient name"))}
      >
        Issue & Anchor
      </button>

      {cert && (
        <div className="bg-white p-4 rounded shadow">
          <p><b>ID:</b> {cert.id}</p>
          <p><b>Hash:</b> {cert.hash}</p>
          <p className="text-sm text-gray-500">{status}</p>
        </div>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
