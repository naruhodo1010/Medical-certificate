<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Medical Certificate System</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const MedicalCertificateSystem = () => {
          const [view, setView] = useState('home');
          const [currentCert, setCurrentCert] = useState(null);
          const [verificationResult, setVerificationResult] = useState(null);
          const [isAuthenticated, setIsAuthenticated] = useState(false);
          const [doctorProfile, setDoctorProfile] = useState(null);
          const [loading, setLoading] = useState(true);

          useEffect(() => {
            const initializeApp = async () => {
              const urlParams = new URLSearchParams(window.location.search);
              const verifyId = urlParams.get('verify');
              
              if (verifyId) {
                try {
                  const result = await window.storage.get(`cert_${verifyId.toUpperCase()}`, true);
                  const cert = result ? JSON.parse(result.value) : null;
                  setVerificationResult(cert);
                  setView('verification');
                  setLoading(false);
                } catch (error) {
                  setVerificationResult(null);
                  setView('verification');
                  setLoading(false);
                }
                return;
              }

              try {
                const result = await window.storage.get('doctor_profile', false);
                const savedProfile = result ? JSON.parse(result.value) : null;
                if (savedProfile) {
                  setDoctorProfile(savedProfile);
                  setIsAuthenticated(true);
                }
              } catch (error) {
                console.log('No saved profile');
              }
              
              setLoading(false);
            };

            initializeApp();
          }, []);

          const loadDoctorProfile = async () => {
            try {
              const result = await window.storage.get('doctor_profile', false);
              return result ? JSON.parse(result.value) : null;
            } catch (error) {
              return null;
            }
          };

          const saveDoctorProfile = async (profile) => {
            try {
              await window.storage.set('doctor_profile', JSON.stringify(profile), false);
              setDoctorProfile(profile);
              setIsAuthenticated(true);
            } catch (error) {
              console.error('Failed to save profile:', error);
            }
          };

          const generateId = () => {
            const timestamp = Date.now().toString(36).toUpperCase();
            const random = Math.random().toString(36).substr(2, 6).toUpperCase();
            return `MC${timestamp}${random}`;
          };

          const issueCertificate = async (formData) => {
            const certId = generateId();
            const certificate = {
              id: certId,
              ...formData,
              issuedDate: new Date().toISOString(),
              issuedBy: doctorProfile.doctorName,
              clinicName: doctorProfile.clinicName,
              licenseNo: doctorProfile.licenseNo,
              status: 'valid'
            };
            
            try {
              await window.storage.set(`cert_${certId}`, JSON.stringify(certificate), true);
              
              const doctorCerts = await loadDoctorCertificates();
              doctorCerts.push(certId);
              await window.storage.set('my_certificates', JSON.stringify(doctorCerts), false);
              
              setCurrentCert(certificate);
              setView('issued');
            } catch (error) {
              alert('Failed to issue certificate. Please try again.');
              console.error('Issue error:', error);
            }
          };

          const loadDoctorCertificates = async () => {
            try {
              const result = await window.storage.get('my_certificates', false);
              return result ? JSON.parse(result.value) : [];
            } catch (error) {
              return [];
            }
          };

          const verifyCertificate = async (certId) => {
            try {
              const result = await window.storage.get(`cert_${certId.toUpperCase()}`, true);
              const cert = result ? JSON.parse(result.value) : null;
              setVerificationResult(cert);
              setView('verification');
            } catch (error) {
              setVerificationResult(null);
              setView('verification');
            }
          };

          const getVerificationUrl = (certId) => {
            return `${window.location.origin}${window.location.pathname}?verify=${certId}`;
          };

          const handleLogout = async () => {
            if (confirm('Are you sure you want to logout?')) {
              setIsAuthenticated(false);
              setDoctorProfile(null);
              setView('home');
            }
          };

          if (loading) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
                <div className="text-center">
                  <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                  <p className="mt-4 text-gray-600">Loading...</p>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
              <div className="max-w-md mx-auto">
                <Header isAuthenticated={isAuthenticated} doctorProfile={doctorProfile} onLogout={handleLogout} />

                {!isAuthenticated && view === 'home' ? (
                  <DoctorLogin onLogin={saveDoctorProfile} />
                ) : (
                  <>
                    {view === 'home' && <HomeView onNavigate={setView} />}
                    {view === 'issue' && <IssueForm onSubmit={issueCertificate} onBack={() => setView('home')} />}
                    {view === 'issued' && currentCert && (
                      <IssuedCertificate cert={currentCert} verificationUrl={getVerificationUrl(currentCert.id)} onBack={() => setView('home')} />
                    )}
                    {view === 'verify' && <VerifyForm onVerify={verifyCertificate} onBack={() => setView('home')} />}
                    {view === 'verification' && <VerificationResult result={verificationResult} onBack={() => setView('home')} />}
                  </>
                )}
              </div>
            </div>
          );
        };

        const Header = ({ isAuthenticated, doctorProfile, onLogout }) => (
          <div className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 shadow-lg no-print">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <div>
                  <h1 className="text-2xl font-bold">Digital Med Cert</h1>
                  <p className="text-blue-100 text-sm">Secure Certificate System</p>
                </div>
              </div>
              {isAuthenticated && (
                <button onClick={onLogout} className="p-2 hover:bg-white/20 rounded-lg transition-colors" title="Logout">
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                  </svg>
                </button>
              )}
            </div>
            {isAuthenticated && doctorProfile && (
              <div className="mt-3 pt-3 border-t border-white/20 text-sm">
                <p className="font-semibold">{doctorProfile.doctorName}</p>
                <p className="text-blue-100">{doctorProfile.clinicName}</p>
              </div>
            )}
          </div>
        );

        const DoctorLogin = ({ onLogin }) => {
          const [isRegistering, setIsRegistering] = useState(false);
          const [showPassword, setShowPassword] = useState(false);
          const [formData, setFormData] = useState({
            doctorName: '',
            clinicName: '',
            licenseNo: '',
            password: '',
            specialty: ''
          });

          const handleSubmit = async () => {
            if (isRegistering) {
              if (!formData.doctorName || !formData.clinicName || !formData.licenseNo || !formData.password) {
                alert('Please fill in all required fields');
                return;
              }
              await onLogin(formData);
            } else {
              setIsRegistering(true);
            }
          };

          return (
            <div className="p-6">
              <div className="bg-white rounded-xl shadow-lg p-6">
                <div className="text-center mb-6">
                  <div className="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg className="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                  </div>
                  <h2 className="text-xl font-bold">{isRegistering ? 'Doctor Registration' : 'Secure Access'}</h2>
                  <p className="text-gray-600 text-sm mt-2">
                    {isRegistering ? 'Register your medical practice' : 'For authorized medical professionals only'}
                  </p>
                </div>

                <div className="space-y-4">
                  {isRegistering && (
                    <>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Doctor Name *</label>
                        <input
                          type="text"
                          value={formData.doctorName}
                          onChange={(e) => setFormData({...formData, doctorName: e.target.value})}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder="Dr. Juan Dela Cruz"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Clinic/Hospital Name *</label>
                        <input
                          type="text"
                          value={formData.clinicName}
                          onChange={(e) => setFormData({...formData, clinicName: e.target.value})}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder="Medical Center Name"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Medical License No. *</label>
                        <input
                          type="text"
                          value={formData.licenseNo}
                          onChange={(e) => setFormData({...formData, licenseNo: e.target.value})}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder="PRC License Number"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Specialty</label>
                        <input
                          type="text"
                          value={formData.specialty}
                          onChange={(e) => setFormData({...formData, specialty: e.target.value})}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder="General Practice, Cardiology, etc."
                        />
                      </div>
                    </>
                  )}

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Password *</label>
                    <div className="relative">
                      <input
                        type={showPassword ? 'text' : 'password'}
                        value={formData.password}
                        onChange={(e) => setFormData({...formData, password: e.target.value})}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-10"
                        placeholder="Enter secure password"
                      />
                      <button
                        onClick={() => setShowPassword(!showPassword)}
                        className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500"
                        type="button"
                      >
                        {showPassword ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}
                      </button>
                    </div>
                  </div>

                  <button
                    onClick={handleSubmit}
                    className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors"
                  >
                    {isRegistering ? 'Complete Registration' : 'Continue'}
                  </button>

                  {isRegistering && (
                    <button onClick={() => setIsRegistering(false)} className="w-full text-blue-600 py-2 text-sm hover:underline">
                      ‚Üê Back
                    </button>
                  )}
                </div>

                <div className="mt-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                  <p className="text-xs text-gray-700">
                    <strong>Demo System:</strong> This is a demonstration. Production would use secure backend authentication.
                  </p>
                </div>
              </div>
            </div>
          );
        };

        const HomeView = ({ onNavigate }) => {
          return (
            <div className="p-6 space-y-4">
              <button
                onClick={() => onNavigate('issue')}
                className="w-full bg-white rounded-xl p-6 shadow-md hover:shadow-lg transition-all flex items-center gap-4 border-2 border-transparent hover:border-blue-300"
              >
                <div className="bg-blue-100 p-3 rounded-lg">
                  <svg className="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                </div>
                <div className="text-left">
                  <h2 className="font-semibold text-lg">Issue New Certificate</h2>
                  <p className="text-gray-600 text-sm">Create a new medical certificate</p>
                </div>
              </button>

              <button
                onClick={() => onNavigate('verify')}
                className="w-full bg-white rounded-xl p-6 shadow-md hover:shadow-lg transition-all flex items-center gap-4 border-2 border-transparent hover:border-green-300"
              >
                <div className="bg-green-100 p-3 rounded-lg">
                  <svg className="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </div>
                <div className="text-left">
                  <h2 className="font-semibold text-lg">Verify Certificate</h2>
                  <p className="text-gray-600 text-sm">Check certificate authenticity</p>
                </div>
              </button>
            </div>
          );
        };

        const IssueForm = ({ onSubmit, onBack }) => {
          const [formData, setFormData] = useState({
            patientName: '',
            patientId: '',
            diagnosis: '',
            startDate: new Date().toISOString().split('T')[0],
            endDate: new Date().toISOString().split('T')[0],
            days: '1',
            remarks: ''
          });

          const handleSubmit = () => {
            if (!formData.patientName || !formData.patientId || !formData.diagnosis) {
              alert('Please fill in all required fields');
              return;
            }
            onSubmit(formData);
          };

          useEffect(() => {
            if (formData.startDate && formData.endDate) {
              const start = new Date(formData.startDate);
              const end = new Date(formData.endDate);
              const diffDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
              setFormData(prev => ({ ...prev, days: diffDays.toString() }));
            }
          }, [formData.startDate, formData.endDate]);

          return (
            <div className="p-6">
              <button onClick={onBack} className="text-blue-600 mb-4 flex items-center gap-2">‚Üê Back</button>
              
              <div className="bg-white rounded-xl shadow-lg p-6">
                <h2 className="text-xl font-bold mb-6">Issue Medical Certificate</h2>
                
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Patient Name *</label>
                    <input
                      type="text"
                      value={formData.patientName}
                      onChange={(e) => setFormData({...formData, patientName: e.target.value})}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      placeholder="Full Name"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Patient ID *</label>
                    <input
                      type="text"
                      value={formData.patientId}
                      onChange={(e) => setFormData({...formData, patientId: e.target.value})}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      placeholder="ID Number"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Diagnosis *</label>
                    <textarea
                      value={formData.diagnosis}
                      onChange={(e) => setFormData({...formData, diagnosis: e.target.value})}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      rows="2"
                      placeholder="Medical condition"
                    />
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Start Date *</label>
                      <input
                        type="date"
                        value={formData.startDate}
                        onChange={(e) => setFormData({...formData, startDate: e.target.value})}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">End Date *</label>
                      <input
                        type="date"
                        value={formData.endDate}
                        onChange={(e) => setFormData({...formData, endDate: e.target.value})}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Number of Days</label>
                    <input
                      type="number"
                      value={formData.days}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50"
                      readOnly
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Additional Remarks</label>
                    <textarea
                      value={formData.remarks}
                      onChange={(e) => setFormData({...formData, remarks: e.target.value})}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      rows="2"
                      placeholder="Optional notes"
                    />
                  </div>

                  <button
                    onClick={handleSubmit}
                    className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors"
                  >
                    Issue Certificate
                  </button>
                </div>
              </div>
            </div>
          );
        };

        const IssuedCertificate = ({ cert, verificationUrl, onBack }) => {
          const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(verificationUrl)}`;

          return (
            <div className="p-6">
              <button onClick={onBack} className="text-blue-600 mb-4 flex items-center gap-2 no-print">‚Üê Back to Home</button>

              <div className="bg-white rounded-xl shadow-lg p-6 mb-4 print-area">
                <div className="text-center mb-6 no-print">
                  <div className="bg-green-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg className="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                  </div>
                  <h2 className="text-xl font-bold text-green-600">Certificate Issued Successfully</h2>
                </div>

                <div className="border-2 border-gray-200 rounded-lg p-6 mb-6">
                  <div className="text-center mb-4">
                    <h3 className="font-bold text-lg">MEDICAL CERTIFICATE</h3>
                    <p className="text-sm text-gray-600">{cert.clinicName}</p>
                    <p className="text-xs text-gray-500 mt-1">License: {cert.licenseNo}</p>
                  </div>

                  <div className="space-y-2 text-sm">
                    <div className="grid grid-cols-2 gap-2 py-2 border-b">
                      <span className="text-gray-600">Certificate ID:</span>
                      <span className="font-semibold font-mono text-xs">{cert.id}</span>
                    </div>
                    <div className="grid grid-cols-2 gap-2 py-2 border-b">
                      <span className="text-gray-600">Patient:</span>
                      <span className="font-semibold">{cert.patientName}</span>
                    </div>
                    <div className="grid grid-cols-2 gap-2 py-2 border-b">
                      <span className="text-gray-600">Patient ID:</span>
                      <span className="font-semibold">{cert.patientId}</span>
                    </div>
                    <div className="grid grid-cols-2 gap-2 py-2 border-b">
                      <span className="text-gray-600">Diagnosis:</span>
                      <span className="font-semibold">{cert.diagnosis}</span>
                    </div>
                    <div className="grid grid-cols-2 gap-2 py-2 border-b">
                      <span className="text-gray-600">MC Period:</span>
                      <span className="font-semibold">{cert.startDate} to {cert.endDate}</span>
                    </div>
                    <div className="grid grid-cols-2 gap-2 py-2 border-b">
                      <span className="text-gray-600">Days:</span>
                      <span className="font-semibold">{cert.days} day(s)</span>
                    </div>
                    <div className="grid grid-cols-2 gap-2 py-2 border-b">
                      <span className="text-gray-600">Issued By:</span>
                      <span className="font-semibold">{cert.issuedBy}</span>
                    </div>
                    <div className="grid grid-cols-2 gap-2 py-2">
                      <span className="text-gray-600">Issued:</span>
                      <span className="font-semibold text-xs">{new Date(cert.issuedDate).toLocaleString()}</span>
                    </div>
                  </div>
                </div>

                <div className="text-center mb-6">
                  <h3 className="font-semibold mb-3">Scan to Verify</h3>
                  <div className="bg-white p-4 inline-block rounded-lg border-2 border-gray-200">
                    <img src={qrCodeUrl} alt="QR Code" className="w-48 h-48" />
                  </div>
                  <p className="text-xs text-gray-500 mt-2">Certificate ID: {cert.id}</p>
                </div>

                <button
                  onClick={() => window.print()}
                  className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors flex items-center justify-center gap-2 no-print"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                  </svg>
                  Print Certificate
                </button>
              </div>
            </div>
          );
        };

        const VerifyForm = ({ onVerify, onBack }) => {
          const [certId, setCertId] = useState('');

          return (
            <div className="p-6">
              <button onClick={onBack} className="text-blue-600 mb-4 flex items-center gap-2">‚Üê Back</button>

              <div className="bg-white rounded-xl shadow-lg p-6">
                <div className="text-center mb-6">
                  <div className="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center
